# 9장. 센티널

# 복제 구성의 주의사항

## 마스터 인스턴스의 장애

아래와 같이 조치 필요

1. 복제본 노드에 접속한 뒤 `REPLICA OF NO ONE` 커맨드 입력하여 읽기 전용 상태 해제
2. 애플리케이션 코드에서 레디스의 엔드포인트를 복제본의 IP로 변경
3. 서비스 배포

⇒ `look aside` 구성으로 사용하는 경우에도 레디스 장애 시 DB로 부하 집중 가능

# 센티널이란?

센티널은 레디스의 자체 고가용성 기능

## 센티널 기능

### 1) 모니터링

- 마스터, 복제본 인스턴스의 상태를 실시간으로 확인

### 2) 자동 페일오버

- 마스터의 비정상 상태 감지, 정상 상태의 복제본 중 하나를 마스터로 승격
- 기존 마스터에 연결된 복제본은 새롭게 승격된 마스터에 연결

### 3) 인스턴스 구성 정보 안내

- 클라이언트에게 현재 구성에서의 마스터 정보를 알려줌
- 페일오버가 발생하면 변경된 마스터 정보 재전달, 페일오버 발생 시에도 레디스의 엔드포인트 변경 불필요

## 분산 시스템으로 동작하는 센티널

- `SPOF`를 방지하기 위해 **최소 3대 이상일 때 정상적으로 동작할 수 있도록 설계**
    - `SPOF` : 하나의 서비스에 문제가 발생했을 때 전체 시스템이 영향을 받는 지점
- `쿼럼` : 마스터가 비정상 동작을 한다는 것에 동의해야 하는 센티널의 수
    - 일반적으로 센티널 인스턴스의 수의 과반으로 설정
- 쿼럼을 이용한 과반수 선출 개념을 사용하므로 3대 이상의 홀수로 구성하는 것이 좋음
    - 보통 3대, 견고하게 하고자 할 경우 5대

## 센티널 인스턴스 배치 방법

- 물리적으로 서로 영향받지 않는 서버에서 실행되는 것이 좋음
- 마스터의 장애를 감지할 수 있어야 하기 때문에 서로 다른 AZ에 배치하는 것이 일반적
- 마스터 장애로 인하여 새로운 마스터가 선출되고, 기존 마스터가 복구된 경우 기존 마스터는 신규 마스터의 복제본으로 연결
- 보통 하나의 서버에 레디스 프로세스와 센티널 프로세스를 동시에 실행, 이런 서버를 3대 구성하는 게 일반적
- 경우에 따라 레디스+센티널 실행 서버 2대, 센티널 실행 서버 1대로 구성하여 비용 절약
    - 센티널만 실행될 서버는 최저 사양의 스펙으로 구성 가능

# 센티널 인스턴스 실행하기

## 테스트 서버 정보

### Server

- Redis Master : 192.168.0.11
- Redis Replica : 192.168.0.22
- Sentinel Only : 192.168.0.33

### Port

- Redis Port : 6379
- Sentinel Port : 26379

### Quorum

- 2

## 센티널 프로세스 실행

### 1) 복제본 연결

```java
REPLICA 192.168.0.11 6379
```

### 2) `sentinel.conf` 설정

```java
port 26379
sentinel monitor master-test 192.168.0.11 6379 2
//               [마스터명]   [마스터 IP] [Port] [Quorum]
```

### 3) 센티널 인스턴스 시작

```bash
# redis-sentinel을 이용하는 방법
redis-sentinel /path/to/sentinel.conf

# redis-server를 이용하는 방법
redis-server /path/to/sentinel.conf --sentinel
```

- 두 방법 모두 동일하게 동작
- 설정 파일이 없거나 해당 경로 데이터를 사용할 수 없는 경우 인스턴스가 시작되지 않음

### 4) 센티널 접속

```bash
$ redis-cli -p 26379
```

### 5) 마스터/복제본, 센티널 인스턴스 모니터링

```bash
SENTINEL master <master-name> # 마스터 모니터링
```

- `num-other-sentinels` : 마스터를 모니터링하고 있는 다른 센티널의 수
- `flags` : 마스터의 상태, `s_down` / `o_down`인 경우 마스터 상태 비정상
- `num-slaves` : 마스터에 연결된 복제본의 개수

```bash
SENTINEL replicas <master-name> # 마스터에 연결된 복제본 모니터링
```

```bash
SENTINEL sentinels <master-name> # 마스터를 모니터링하는 센티널 모니터링
```

```bash
SENTINEL chkquorum <master-name> # 정상 센티널 인스턴스의 수가 설정한 쿼럼 값보다 큰지 확인
```

## 페일오버 테스트

- 센티널은 주기적으로 마스터 노드에 PING을 보내 응답이 정상적으로 돌아오는지 확인
- `sentinel.conf` 내 지정한 `down-after-milliseconds` 시간 동안 마스터에서 응답이 오지 않으면 마스터의 상태가 정상적이지 않다고 판단하여 페일오버 트리거 (기본 값 : 30,000)

### 수동 페일오버

```bash
SENTINEL FAILOVER <master-name>
```

- 다른 센티널의 동의를 구하지 않고 페일오버 발생 가능
- 실제 마스터의 상태가 정상임에도 마스터와 복제본 간 롤 체인지 발생
- 아래 내용 확인 가능
    - 네트워크 단절 등 이슈로 페일오버가 실패하지 않는지
    - 센티널에 연결된 애플리케이션 커넥션이 변경된 마스터에 연결되는지

### 자동 페일오버

```bash
redis-cli -h <master-host> -p <master-port> shutdown
```

- 직접 마스터 노드에 장애를 발생시켜 페일오버가 정상적으로 발생하는지 확인
- 센티널의 주기적인 헬스 체크를 이용한 자동 페일오버 테스트
- `sentinel.conf` 내 지정한 `down-after-milliseconds` 가 지난 후 페일오버가 발생하는지 확인

# 센티널 운영하기

## 패스워드 인증

- 마스터와 복제본 노드에 `requirepass` / `masterauth` 옵션을 이용해 패스워드를 설정한 경우 센티널 설정 파일에도 패스워드 지정 필요
- 복제 구성 내 모든 레디스 노드는 마스터 노드가 될 가능성이 있으므로 `requirepass` / `masterauth` 옵션은 모든 노드에서 동일하게 설정 필요
- 패스워드가 걸려 있는 레디스 모니터링 시 아래와 같이 패스워드 지정 필요
    
    ```bash
    sentinel auth-pass <master-name> <password>
    ```
    

## 복제본 우선순위

- 모든 레디스 인스턴스는 `replica-priority` 파라미터 보유 (기본 값 : 100)
- 센티널은 페일오버 진행 시 **각 복제본 노드의 우선순위 확인 후 해당 값이 가장 작은 노드 선출**
- 우선순위 값이 0인 경우 절대 마스터로 선출되지 않음

## 운영 중 센티널 구성 정보 변경

### 1) 모니터링 대상 마스터 추가

```bash
SENTINEL MONITOR <master-name> <ip> <port> <quorum>
```

- 센티널 실행 도중 마스터 추가 가능 (단, 설정이 다른 센티널로 전파되지 않음)
- 센티널이 여러 대인 경우 각각의 센티널에 모두 설정 적용 필요

### 2) 모니터링 대상 마스터 삭제

```bash
SENTINEL REMOVER <master-name>
```

- 센티널 내부 상태에서 완전히 제거
- `SENTINEL masters` 등의 커맨드에서 해당 마스터가 나열되지 않음

### 3) 특정 마스터 대상 파라미터 변경

```bash
SENTINEL SET <master-name> [<option> <value> ...]
```

- 쿼럼, `down-after-milliseconds` 등 각종 옵션 값 변경 가능

### 4) 마스터에 종속되지 않는 센티널의 설정 변경

```bash
SENTINEL CONFIG GET <configuration-name>
SENTINEL CONFIG SET <configuration-name> <value>
```

- 레디스 버전 6.2부터 사용 가능
- 런타임 중 설정 변경 가능

## 센티널 초기화

- 비정상적이라 판단한 복제본 노드에 대해서도 임의로 모니터링을 멈추지 않음
- 해당 서버를 더 이상 사용할 수 없어 모니터링 중단 시 아래 명령어 사용하여 센티널 인스턴스 정보 초기화 필요
    
    ```bash
    SENTINEL RESET <master-name> # 센티널 인스턴스의 상태 정보 초기화
    ```
    
    - 센티널이 모니터링하고 있는 마스터, 복제본, 다른 센티널 인스턴스의 정보 새로고침
    - 마스터명 대신 `*` 사용 시 전체 마스터 정보 초기화 가능

## 센티널 노드의 추가/제거

추가 및 제거 이후 아래 명령어 통하여 정상적으로 추가됐는지 확인

```bash
SENTINEL MASTER <master-name> # num-other-sentinels 확인
```

### 노드 추가

- 동일 마스터를 모니터링 하도록 설정한 센티널 인스턴스 실행 시 
자동 검색 메커니즘에 의해 자동으로 기존에 실행 중이던 다른 센티널의 **known-list**에 추가됨
- 한 번에 여러 대의 센티널을 추가해야 하는 경우 **10초 이상의 간격**을 두고 
1개씩 목록에 들어가도록 천천히 추가하는 것이 오류 발생 가능성을 줄일 수 있음

### 노드 삭제

- 센티널 노드끼리는 오랜 시간 응답이 존재하지 않아도 센티널의 **known-list**에서 제거하지 않음
- 센티널 프로세스 먼저 종료 후, `SENTINEL RESET *` 커맨드를 이용해 모니터링 정보 리셋 필요
- 센티널 인스턴스 간 **최소 30초**의 대기 시간을 가지며 차례대로 실행하는 것이 좋음

## 센티널의 자동 페일오버 과정

### 1) 마스터의 장애 상황 감지

- `down-after-milliseconds` 파라미터에 지정된 값 이상 동안 마스터에 `PING` 유효 응답을 받지 못한 경우 마스터 장애로 판단
    - PING 유효 응답 : `+PONG`, `-LOADING`, `-MASTERDOWN`
    - 다른 응답을 받거나 응답을 받지 못한 경우 유효하지 않은 응답으로 판단

### 2) `sdown`, `odown` 실패 상태로 전환

- 마스터 인스턴스에 대한 응답을 늦게 받으면 마스터의 상태를 `sdown(subjectly down)` 으로 플래그 변경
- 센티널 노드는 다른 센티널 노드들에게 장애 사실 전파
    
    ```bash
    SENTINEL is-master-down-by-addr <master-ip> <master-port> <current-epoch> <*>
    ```
    
- 전파 받은 센티널들은 장애를 인지했는지 여부를 응답
- 자기 자신 포함 쿼럼 값 이상의 센티널 노드에서 마스터의 장애를 인지한 경우 `odown(objectly down)`으로 변경
    - 센티널은 마스터에 한하여 `odown` 상태를 가짐
- 복제본 노드 장애 시 `sdown` 플래깅 후 장애 전파 등의 과정은 진행하지 않음
    - 단, 페일오버 진행 시 `sdown` 상태의 복제본은 마스터로 승격되지 않도록 함

### 3) 에포크 증가

- 처음으로 마스터 노드를 `odown`으로 인지한 센티널 노드가 페일오버 과정 시작
- 페일오버 시작 전 에포크(epoch) 값 하나 증가, 마스터에서 발생한 페일오버의 버전을 관리
    - 최초 페일오버 발생 시 에포크는 `1`

### 4) 센티널 리더 선출

- 에포크를 증가시킨 센티널은 다른 센티널에 센티널 리더 선출을 위한 투표 요청 메시지 발송
    
    (이때, 증가시킨 에포크 함께 전달)
    
- 메시지를 전달 받은 다른 센티널 노드의 대응
    - 자신의 에포크 < 전달 받은 에포크
        - 자신의 에포크 증가
        - 센티널 리더에게 투표하겠다는 응답 전송
    - 자신의 에포크 == 전달 받은 에포크
        - 이미 리더로 선출한 센티널의 id 응답
- 하나의 에포크에서 센티널은 하나의 센티널에 투표 가능, 투표 결과 변경 불가
    
    ```bash
    sentinel.log
    +vote-for-leader
    +elected-leader
    ```
    
- **쿼럼 값과 상관 없이 실제 센티널 개수 중 과반수 이상의 센티널의 동의를 얻어야만 리더 선출**

### 5) 복제본 선정 후 마스터로 승격

- 과반수 이상의 센티널이 페일오버에 동의 시 리더 센티널은 페일오버 시도
- 마스터가 될 수 있는 복제본 선정 시 아래 규칙에 따름
- 선정된 복제본에는 `slaveof no one` 커맨드 수행하여, 기존 마스터로부터 복제 해제

```bash
sentinel.log
+failover-state-select-slave
+selected-slave
+failover-state-send-slaveof-noone
+promoted-slave
```

🗳️ **복제본 선정 기준**

1. `redis.conf` 파일에 명시된 `replica-priority` 가 낮은 복제본
2. 마스터로부터 더 많은 데이터를 수신한 복제본 (master_repl_오프셋)
3. 2번 조건까지 동일할 경우 `runID`가 사전 순으로 작은 복제본

### 6) 복제본 연결 변경

- 기존 마스터에 연결되어 있던 다른 복제본이 새로 승격된 마스터의 복제본이 될 수 있도록
    
    `replicaof new-ip new-port` 명령어 수행
    
- 복제 그룹의 모든 센티널 노드에서도 레디스의 구성 정보 변경

```bash
sentinel.log
+failover-state-reconf-slaves
+slave-reconf-sent
+slave-reconf-inprog
+slave-reconf-done
+config-update-from sentinel
```

### 7) 장애 조치 완료

- 모든 과정이 완료된 뒤 센티널은 새로운 마스터 모니터링

```bash
sentinel.log
+failover-end
+switch-master
```

## 스플릿 브레인 현상

- 네트워크 파티션 이슈로 분산 환경의 데이터 저장소가 끊어지고, 끊긴 두 부분이 각각을 정상 서비스로 인식하는 현상
- 센티널 구성에서 네트워크 단절 시 해당 현상 발생 가능

### 발생 가능 상황 (274pg)

1. 마스터 노드와 센티널 인스턴스 A가 다른 복제본 노드 및 센티널 인스턴스와 네트워크 단절
2. 센티널 B와 C는 복제본 노드를 마스터로 승격 (과반수 이상이 찬성 가능)
3. 이때 마스터 인스턴스에 장애가 발생하지 않은 경우 하나의 복제본에 2개의 마스터가 존재
4. 기존 마스터 노드에 연결됐던 클라이언트는 계속 기존 마스터에 데이터 입력
    
    (클라이언트는 레디스에 커넥션 생성 시 마스터 주소 질의 후 마스터에 연결)
    
5. 신규 레디스 커넥션은 신규 마스터로 연결, 신규 마스터에 데이터 입력
6. **네트워크 단절 복구 시 기존 마스터는 신규 마스터의 복제본으로 연결**
    
    ⇒ 이때 복제본으로 연결되는 과정에서 복제본 노드의 데이터는 모두 삭제
    
7. 기존 마스터에 입력된 데이터 유실
